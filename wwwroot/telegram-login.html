<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Авторизация через Telegram</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="background:#111; color:white; font-family:sans-serif; padding:20px;">

<h2>Авторизация через Telegram</h2>

<div id="tg-login"></div>
<div id="status"></div>

<script>
    // ----------------------------
    // 1) Читаем nonce из URL
    // ----------------------------
    const url = new URL(window.location.href);
    const nonce = url.searchParams.get("nonce");

    if (!nonce) {
        document.getElementById('status').innerHTML = "<h3 style='color:red'>Ошибка: нет nonce</h3>";
        throw new Error("No nonce");
    }

    // ----------------------------
    // 2) Конфиг
    // ----------------------------
    const API_URL = "https://droopingly-troughlike-dedra.ngrok-free.dev";

    // ----------------------------
    // 3) Подключаем Telegram Login Widget
    // ----------------------------
    function initTelegramWidget() {
        const tgScript = document.createElement("script");
        tgScript.src = "https://telegram.org/js/telegram-widget.js?22";
        tgScript.async = true;
        tgScript.setAttribute("data-telegram-login", "subopro_bot");
        tgScript.setAttribute("data-size", "large");
        tgScript.setAttribute("data-userpic", "true");
        tgScript.setAttribute("data-request-access", "write");
        tgScript.setAttribute("data-lang", "ru");
        tgScript.setAttribute("data-on-auth", "onTelegramAuth");

        document.getElementById("tg-login").appendChild(tgScript);
    }

    // ----------------------------
    // 4) Callback после логина
    // ----------------------------
    async function onTelegramAuth(user) {
        document.getElementById('status').innerHTML = "<p>Проверка авторизации...</p>";
        
        const payload = {
            nonce: nonce,
            telegramData: {
                Id: user.id.toString(),
                FirstName: user.first_name,
                Username: user.username,
                AuthDate: user.auth_date.toString(),
                Hash: user.hash
            }
        };

        console.log("Sending payload:", payload);

        try {
            const response = await fetch(`${API_URL}/api/auth/verify`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const json = await response.json();

            if (json.token) {
                document.getElementById('status').innerHTML = 
                    "<h3 style='color:green'>✅ Успешная авторизация!</h3>" +
                    "<p>Токен получен. Закройте это окно.</p>";
                
                // Отправляем токен в мобильное приложение
                if (window.Android && window.Android.receiveToken) {
                    // Для Android WebView
                    window.Android.receiveToken(json.token);
                } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.iosListener) {
                    // Для iOS WKWebView
                    window.webkit.messageHandlers.iosListener.postMessage({token: json.token});
                } else {
                    // Fallback: пытаемся открыть кастомную схему URL
                    setTimeout(() => {
                        window.location.href = `todoapp://auth?token=${encodeURIComponent(json.token)}`;
                    }, 1000);
                }
            } else {
                document.getElementById('status').innerHTML = 
                    "<h3 style='color:red'>❌ Ошибка авторизации</h3>" +
                    "<pre>" + JSON.stringify(json, null, 2) + "</pre>";
            }
        } catch (error) {
            document.getElementById('status').innerHTML = 
                "<h3 style='color:red'>❌ Ошибка сети</h3>" +
                "<p>" + error.message + "</p>";
        }
    }

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', initTelegramWidget);
</script>

</body>
</html>